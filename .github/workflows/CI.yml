# This file is autogenerated by maturin v1.5.1
# To update, run
#
#    maturin generate-ci github -o .github/workflows/CI.yml
#
name: CI

on:
  push:
    branches:
      - main
      - master
    tags:
      - "*"
  pull_request:
  workflow_dispatch:

permissions:
  contents: read

jobs:
  linux:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"
      - name: Build wheels
        uses: PyO3/maturin-action@v1
        with:
          target: x86_64
          args: --release --out dist
          sccache: "true"
          manylinux: auto
      - name: Upload wheels
        uses: actions/upload-artifact@v4
        with:
          name: wheels-linux-x86_64
          path: dist

  macos:
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"
      - name: Build wheels
        uses: PyO3/maturin-action@v1
        with:
          target: x86_64
          args: --release --out dist
          sccache: "true"
      - name: Upload wheels
        uses: actions/upload-artifact@v4
        with:
          name: wheels-macos-x86_64
          path: dist

  sdist:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Build sdist
        uses: PyO3/maturin-action@v1
        with:
          command: sdist
          args: --out dist
      - name: Upload sdist
        uses: actions/upload-artifact@v4
        with:
          name: wheels-sdist
          path: dist

  release:
    name: Release
    runs-on: ubuntu-latest
    if: "startsWith(github.ref, 'refs/tags/')"
    needs: [linux, macos, sdist]
    permissions:
      contents: write
      pages: write
    steps:
      - uses: actions/download-artifact@v4
      - name: Upload to GitHub Releases
        uses: softprops/action-gh-release@v2
        with:
          files: wheels-*/*
          fail_on_unmatched_files: true
      - name: Create simple repository index
        run: |
          mkdir -p simple/rbloom
          cd simple/rbloom

          # Create index.html with all wheels
          cat > index.html <<'EOF'
          <!DOCTYPE html>
          <html>
            <head><title>Links for rbloom</title></head>
            <body>
              <h1>Links for rbloom</h1>
          EOF

          # Add links for all wheels and sdist
          for file in ../../wheels-*/*; do
            filename=$(basename "$file")
            echo "      <a href=\"https://github.com/marin-community/rbloom/releases/download/${{ github.ref_name }}/$filename\">$filename</a><br/>" >> index.html
          done

          cat >> index.html <<'EOF'
            </body>
          </html>
          EOF

          # Create root index
          cd ..
          cat > index.html <<'EOF'
          <!DOCTYPE html>
          <html>
            <head><title>Simple index</title></head>
            <body>
              <a href="rbloom/">rbloom</a><br/>
            </body>
          </html>
          EOF
      - name: Deploy to GitHub Pages
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./simple
          keep_files: false
      - name: Publish to PyPI
        uses: PyO3/maturin-action@v1
        env:
          MATURIN_PYPI_TOKEN: ${{ secrets.PYPI_API_TOKEN }}
        with:
          command: upload
          args: --non-interactive --skip-existing wheels-*/*
